<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYPER - NEON TUBE</title>
    <style>
        /* =========================================
           CORE STYLES
           ========================================= */
        :root {
            --bg-color: #050505;
            --text-main: #b0b0b0; /* 基础文字：冷灰 */
            --text-dim: #666666;  /* 暗淡文字 */
            
            /* 复古真空管绿 */
            --tube-green: #33ff33; 
            /* 辉光滤镜：核心亮，周围有漫射光 */
            --tube-glow: 0 0 2px #33ff33, 0 0 8px rgba(51, 255, 51, 0.6), 0 0 15px rgba(51, 255, 51, 0.2);
            
            --panel-bg: rgba(5, 5, 5, 0.95);
            --font-stack: "Menlo", "Monaco", "Consolas", "Courier New", monospace;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background-color: var(--bg-color); color: var(--text-main);
            font-family: var(--font-stack); font-size: 14px;
            overflow: hidden; user-select: none;
        }

        /* 视觉层：保持全彩 */
        #visual-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.8;
        }

        /* UI 层 */
        #terminal-ui {
            position: relative; z-index: 10; width: 100%; height: 100%;
            padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
            pointer-events: none; 
        }

        /* === 重点：真空管风格类 === */
        .neon-text {
            color: var(--tube-green);
            text-shadow: var(--tube-glow); /* 关键：发光滤镜 */
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .neon-border {
            border-color: var(--tube-green) !important;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.3), inset 0 0 5px rgba(51, 255, 51, 0.1);
        }

        .header-info {
            pointer-events: auto; white-space: pre-wrap;
            margin-bottom: 10px; color: var(--text-dim);
            border-bottom: 1px dashed #333; padding-bottom: 10px;
            display: flex; justify-content: space-between; flex-shrink: 0;
        }

        /* 系统开关：默认灰色，悬停变绿发光 */
        #sys-trigger {
            cursor: pointer; color: var(--text-dim);
            border: 1px solid #444; padding: 2px 8px;
            display: none; font-size: 12px;
            z-index: 2000; transition: all 0.2s;
        }
        #sys-trigger:hover { 
            color: var(--tube-green);
            border-color: var(--tube-green);
            text-shadow: var(--tube-glow);
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.2);
        }

        #terminal-history {
            flex-grow: 1; display: flex; flex-direction: column;
            justify-content: flex-end; padding-bottom: 15px;
            pointer-events: auto;
            transition: opacity 0.5s ease; 
            overflow-y: auto; min-height: 0; scrollbar-width: none;
        }
        #terminal-history::-webkit-scrollbar { display: none; }
        #terminal-history.dimmed { opacity: 0.1; filter: blur(1px); }

        .log-entry { margin-bottom: 4px; white-space: pre-wrap; word-break: break-all; }
        .sys { color: var(--text-dim); } 
        /* 成功信息使用荧光绿 */
        .success { color: var(--tube-green); text-shadow: 0 0 5px rgba(51, 255, 51, 0.4); } 
        .warn { color: #ff3333; text-shadow: 0 0 5px rgba(255, 51, 51, 0.4); }

        /* 输入区 */
        .input-area {
            display: flex; align-items: center; 
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 15px; background: transparent; 
            pointer-events: auto; flex-shrink: 0; 
            position: relative; z-index: 10001; 
        }
        
        /* 提示符使用强烈的荧光绿 */
        .prompt { margin-right: 10px; }
        
        #cmd-input {
            flex-grow: 1; background: transparent; border: none;
            color: #fff; /* 输入文字保持纯白，对比清晰 */
            font-family: inherit; font-size: 16px; outline: none;
            text-shadow: 0 0 2px rgba(255,255,255,0.5);
        }
        #file-input { display: none; }

        /* 控制面板 */
        #control-panel {
            position: absolute; top: 60px; right: 20px;
            width: 400px; max-height: calc(100% - 100px); 
            overflow-y: auto;
            background: var(--panel-bg); 
            border: 1px solid #333; 
            padding: 15px; display: none; 
            z-index: 9999; 
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            pointer-events: auto; font-family: var(--font-stack);
        }
        #control-panel::-webkit-scrollbar { width: 3px; }
        #control-panel::-webkit-scrollbar-track { background: #000; }
        #control-panel::-webkit-scrollbar-thumb { background: #333; }

        .panel-header {
            border-bottom: 1px solid #333; padding-bottom: 5px;
            margin-bottom: 10px; color: #888;
            position: sticky; top: 0; background: var(--panel-bg); z-index: 1;
            display: flex; justify-content: space-between;
        }
        .close-btn { cursor: pointer; color: #555; }
        .close-btn:hover { color: #fff; }

        .module-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }

        .module-btn {
            border: 1px solid #222; padding: 6px 10px; cursor: pointer;
            font-size: 11px; color: #777; transition: all 0.1s; text-align: left;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            background: rgba(0,0,0,0.3);
        }
        .module-btn:hover { border-color: #555; color: #ccc; }
        
        /* 激活的按钮：变成荧光管风格 */
        .module-btn.active { 
            background: rgba(0, 30, 0, 0.8); 
            color: var(--tube-green); 
            border-color: var(--tube-green);
            text-shadow: var(--tube-glow);
            box-shadow: inset 0 0 10px rgba(51, 255, 51, 0.1);
        }
        
        .hint-text {
            position: absolute; bottom: 10px; right: 20px;
            color: #333; font-size: 10px; pointer-events: none;
            z-index: 5;
        }
        #terminal-ui.hidden { opacity: 0; }
    </style>
</head>
<body>

<canvas id="visual-canvas"></canvas>

<div id="terminal-ui">
    <div class="header-info">
        <div><span class="neon-text">TYPER</span> OMNI [v51.5 TUBE]</div>
        <div id="sys-trigger">[ OPEN PANEL ]</div>
    </div>

    <div id="terminal-history"></div>
    
    <div class="input-area" id="input-container">
        <span class="prompt neon-text">CMD&gt;</span>
        <input type="text" id="cmd-input" autocomplete="off" spellcheck="false" autofocus>
    </div>
</div>

<div class="hint-text">[TAB] HIDE UI</div>

<div id="control-panel">
    <div class="panel-header">
        <span>VISUAL MODULES</span>
        <span class="close-btn" onclick="togglePanel()">×</span>
    </div>
    <div class="module-grid" id="module-grid"></div>
</div>

<input type="file" id="file-input" multiple accept="audio/*">

<script>
    // --- STATE ---
    const STATE = { mode: 0, isPlaying: false, playlist: [], trackIndex: 0 };
    
    // --- MODES (Original Concept Restored) ---
    const MODES = [
        { id: 0, name: "SPECTRUM BARS", desc: "Standard freq analysis" },
        { id: 1, name: "OSCILLOSCOPE", desc: "Raw waveform" },
        { id: 2, name: "RADAR SCAN", desc: "Polar map" },
        { id: 3, name: "BINARY RAIN", desc: "Matrix simulation" },
        { id: 4, name: "DNA HELIX", desc: "Genetic map" },
        { id: 5, name: "VORTEX", desc: "Centripetal force" },
        { id: 6, name: "HEX DUMP", desc: "Memory monitor" },
        { id: 7, name: "GRAVITY", desc: "Particle physics" },
        { id: 8, name: "SONAR", desc: "Acoustic ping" },
        { id: 9, name: "GLITCH", desc: "Signal corruption" },
        { id: 10, name: "SEISMOGRAPH", desc: "Amplitude log" },
        { id: 11, name: "STARFIELD", desc: "Warp navigation" },
        { id: 12, name: "NETWORK", desc: "Node topology" },
        { id: 13, name: "COMPASS", desc: "Directional vector" },
        { id: 14, name: "BARCODE", desc: "Data density" },
        { id: 15, name: "TERMINAL", desc: "Code execution" },
        { id: 16, name: "HEATMAP", desc: "Thermal grid" },
        { id: 17, name: "VOICEPRINT", desc: "Biometric ID" },
        { id: 18, name: "GLOBE", desc: "3D Wireframe" },
        { id: 19, name: "NOISE", desc: "Static interference" },
        { id: 20, name: "HEARTBEAT", desc: "EKG Monitor" },
        { id: 21, name: "KALEIDOSCOPE", desc: "Mirrored geometry" },
        { id: 22, name: "CIRCUIT BOARD", desc: "PCB Traces glowing" },
        { id: 23, name: "CITY SKYLINE", desc: "Building heights by freq" },
        { id: 24, name: "BLACK HOLE", desc: "Accretion disk Event Horizon" },
        { id: 25, name: "FLUID DYNAMICS", desc: "Swirling smoke/ink" },
        { id: 26, name: "RETRO CRT", desc: "Old TV scanlines & warp" },
        { id: 27, name: "NEURAL NET", desc: "Synaptic firing paths" },
        { id: 28, name: "LIGHTNING", desc: "Electrical arcs" },
        { id: 29, name: "PLANETARY ORBIT", desc: "Solar system simulation" },
        { id: 30, name: "RORSCHACH", desc: "Inkblot psychology test" },
        { id: 31, name: "ASCII PORTRAIT", desc: "Reactive face/skull" },
        { id: 32, name: "SPIROGRAPH", desc: "Geometric curve drawing" },
        { id: 33, name: "TANK TRACKS", desc: "Scrolling tread pattern" },
        { id: 34, name: "DIGITAL RAINBOW", desc: "RGB color separation" },
        { id: 35, name: "FIREWORKS", desc: "Explosions on beat" },
        { id: 36, name: "TUNNEL DIVE", desc: "Infinite wireframe tunnel" },
        { id: 37, name: "LIQUID METAL", desc: "Ferrofluid simulation" },
        { id: 38, name: "NIXIE TUBES", desc: "Glowing retro digits" },
        { id: 39, name: "VORONOI CELLS", desc: "Organic cellular structure" },
        { id: 40, name: "TEXT CLOUD", desc: "Floating audio words" },
        { id: 41, name: "RIPPLE TANK", desc: "Water surface wave interference" },
        { id: 42, name: "TESLA COIL", desc: "High voltage discharges" },
        { id: 43, name: "PIXEL SORT", desc: "Glitch art sorting" },
        { id: 44, name: "HUD TARGETING", desc: "Fighter jet interface" },
        { id: 45, name: "SOUND WORM", desc: "Segmented creature" },
        { id: 46, name: "CROP CIRCLES", desc: "Alien patterns appearing" },
        { id: 47, name: "FRACTAL TREE", desc: "Recursive growth structure" },
        { id: 48, name: "MAGNETIC FIELD", desc: "Iron filings aligning" },
        { id: 49, name: "EQUALIZER RINGS", desc: "Concentric circular EQ" },
        { id: 50, name: "THE ABYSS", desc: "Staring back at you" }
    ];

    const DOM = {
        cvs: document.getElementById('visual-canvas'),
        ctx: document.getElementById('visual-canvas').getContext('2d'),
        ui: document.getElementById('terminal-ui'),
        history: document.getElementById('terminal-history'),
        inputCont: document.getElementById('input-container'),
        input: document.getElementById('cmd-input'),
        trigger: document.getElementById('sys-trigger'),
        panel: document.getElementById('control-panel'),
        grid: document.getElementById('module-grid')
    };

    // --- AUDIO & RENDER ENGINE ---
    let audioCtx, analyser, source, audioEl, dataArray, bufferLength;
    function initAudio() {
        if (audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        audioEl = new Audio(); audioEl.crossOrigin = "anonymous";
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512; analyser.smoothingTimeConstant = 0.85;
        const gain = audioCtx.createGain(); gain.gain.value = 0.5;
        source = audioCtx.createMediaElementSource(audioEl);
        source.connect(analyser); analyser.connect(gain); gain.connect(audioCtx.destination);
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        audioEl.addEventListener('ended', () => playNext());
    }

    function resize() { DOM.cvs.width = window.innerWidth; DOM.cvs.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    const map = (val, s1, e1, s2, e2) => (val - s1) * (e2 - s2) / (e1 - s1) + s2;
    const toRad = (deg) => deg * Math.PI / 180;

    // --- MAIN RENDER LOOP (Restored to Multicolor) ---
    function render() {
        requestAnimationFrame(render);
        const ctx = DOM.ctx; const w = DOM.cvs.width; const h = DOM.cvs.height;
        if (![3, 36, 37].includes(STATE.mode)) { ctx.fillStyle = "rgba(5,5,5,0.7)"; ctx.fillRect(0, 0, w, h); }
        ctx.font = "14px monospace"; ctx.textBaseline = "top";
        let bass = 0;
        if (analyser && STATE.isPlaying) {
            analyser.getByteFrequencyData(dataArray);
            let bVal = 0; for(let i=0; i<15; i++) bVal += dataArray[i];
            bass = bVal / 15 / 255;
        }

        switch(STATE.mode) {
             case 0: drawSpectrum(ctx, w, h); break; case 1: drawOscilloscope(ctx, w, h); break; case 2: drawRadar(ctx, w, h, bass); break;
             case 3: drawBinaryRain(ctx, w, h, bass); break; case 4: drawDNA(ctx, w, h, bass); break; case 5: drawVortex(ctx, w, h, bass); break;
             case 6: drawHexDump(ctx, w, h); break; case 7: drawGravity(ctx, w, h, bass); break; case 8: drawSonar(ctx, w, h, bass); break;
             case 9: drawGlitch(ctx, w, h, bass); break; case 10: drawSeismograph(ctx, w, h); break; case 11: drawStarfield(ctx, w, h, bass); break;
             case 12: drawNetwork(ctx, w, h, bass); break; case 13: drawCompass(ctx, w, h, bass); break; case 14: drawBarcode(ctx, w, h); break;
             case 15: drawTerminal(ctx, w, h); break; case 16: drawHeatmap(ctx, w, h, bass); break; case 17: drawVoiceprint(ctx, w, h, bass); break;
             case 18: drawGlobe(ctx, w, h, bass); break; case 19: drawNoise(ctx, w, h); break; case 20: drawHeartbeat(ctx, w, h, bass); break;
             case 21: drawKaleidoscope(ctx, w, h, bass); break; case 22: drawCircuitBoard(ctx, w, h, bass); break; case 23: drawCitySkyline(ctx, w, h, bass); break;
             case 24: drawBlackHole(ctx, w, h, bass); break; case 25: drawFluid(ctx, w, h, bass); break; case 26: drawRetroCRT(ctx, w, h, bass); break;
             case 27: drawNeuralNet(ctx, w, h, bass); break; case 28: drawLightning(ctx, w, h, bass); break; case 29: drawPlanets(ctx, w, h, bass); break;
             case 30: drawRorschach(ctx, w, h, bass); break; case 31: drawAsciiPortrait(ctx, w, h, bass); break; case 32: drawSpirograph(ctx, w, h, bass); break;
             case 33: drawTankTracks(ctx, w, h, bass); break; case 34: drawDigitalRainbow(ctx, w, h); break; case 35: drawFireworks(ctx, w, h, bass); break;
             case 36: drawTunnelDive(ctx, w, h, bass); break; case 37: drawLiquidMetal(ctx, w, h, bass); break; case 38: drawNixieTubes(ctx, w, h, bass); break;
             case 39: drawVoronoi(ctx, w, h, bass); break; case 40: drawTextCloud(ctx, w, h, bass); break; case 41: drawRippleTank(ctx, w, h, bass); break;
             case 42: drawTeslaCoil(ctx, w, h, bass); break; case 43: drawPixelSort(ctx, w, h, bass); break; case 44: drawHUD(ctx, w, h, bass); break;
             case 45: drawSoundWorm(ctx, w, h, bass); break; case 46: drawCropCircles(ctx, w, h, bass); break; case 47: drawFractalTree(ctx, w, h, bass); break;
             case 48: drawMagneticField(ctx, w, h, bass); break; case 49: drawEQRings(ctx, w, h, bass); break; case 50: drawTheAbyss(ctx, w, h, bass); break;
        }
    }

    // --- DRAW FUNCTIONS (Restored Multicolor) ---
    function drawSpectrum(ctx,w,h){const bars=64,step=Math.floor(bufferLength/bars),barW=w/bars;for(let i=0;i<bars;i++){const val=dataArray?dataArray[i*step]:0,pct=val/255,ht=pct*h*0.8,cc=Math.floor(ht/16);for(let j=0;j<cc;j++){ctx.fillStyle=j>h/16*0.6?"#ff3333":"#00ffcc";ctx.fillText(j%2===0?"█":"▓",i*barW,h-(j*16));}}}
    function drawOscilloscope(ctx,w,h){if(!analyser)return;const td=new Uint8Array(bufferLength);analyser.getByteTimeDomainData(td);ctx.fillStyle="#00ffcc";const sw=w*1.0/bufferLength;let x=0;for(let i=0;i<bufferLength;i++){const v=td[i]/128.0,y=v*h/2,c=v>1.05?"^":v<0.95?"v":"-";ctx.fillText(c,x,y);x+=sw;}}
    function drawRadar(ctx,w,h,bass){const cx=w/2,cy=h/2,r=Math.min(w,h)/3,t=Date.now()*0.002;ctx.strokeStyle="#00ffcc";ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(t)*w,cy+Math.sin(t)*w);ctx.stroke();const cnt=30,step=Math.floor(bufferLength/cnt);for(let i=0;i<cnt;i++){const val=dataArray?dataArray[i*step]:0;if(val>100){const a=map(i,0,cnt,0,Math.PI*2),rad=map(val,0,255,0,r),tx=cx+Math.cos(a)*rad,ty=cy+Math.sin(a)*rad;ctx.fillStyle=val>200?"#ff3333":"#00ffcc";ctx.fillText(val>200?"TGT":"+",tx,ty);}}}
    let drops=[];function drawBinaryRain(ctx,w,h,bass){ctx.fillStyle="rgba(5,5,5,0.2)";ctx.fillRect(0,0,w,h);const cols=Math.floor(w/10);if(drops.length!==cols)drops=new Array(cols).fill(0);ctx.fillStyle="#0f0";for(let i=0;i<cols;i++){const c=Math.random()>0.5?"1":"0",val=dataArray?dataArray[i%bufferLength]:0,spd=val>128?2:1;ctx.fillStyle=`rgba(0,255,0,${val/255})`;ctx.fillText(c,i*10,drops[i]*16);if(drops[i]*16>h&&Math.random()>0.975)drops[i]=0;drops[i]+=spd+(bass*2);}}
    function drawDNA(ctx,w,h,bass){const cx=w/2,t=Date.now()*0.002,strands=20;for(let i=0;i<strands;i++){const y=(i/strands)*h,off=Math.sin(t+i*0.5)*(100+bass*100);ctx.fillStyle="#00ffcc";ctx.fillText("A-T",cx+off,y);ctx.fillStyle="#ff3333";ctx.fillText("G-C",cx-off,y);ctx.fillStyle="#333";const steps=Math.abs(off*2)/10;for(let j=0;j<steps;j++)ctx.fillText(".",cx-off+(j*10),y);}}
    function drawVortex(ctx,w,h,bass){const cx=w/2,cy=h/2,t=Date.now()*0.001;for(let i=0;i<100;i++){const a=0.1*i+t*(1+bass*5),r=5*i*(0.5+bass),x=cx+Math.cos(a)*r,y=cy+Math.sin(a)*r,val=dataArray?dataArray[i%bufferLength]:0;ctx.fillStyle=`hsl(${val},100%,50%)`;ctx.fillText(String.fromCharCode(65+(i%26)),x,y);}}
    function drawHexDump(ctx,w,h){let idx=0;for(let y=0;y<h/16;y++){let l=`0x${(y*16).toString(16).padStart(4,'0').toUpperCase()}: `;for(let x=0;x<16;x++){const v=dataArray?dataArray[(idx+x)%bufferLength]:0;l+=v.toString(16).padStart(2,'0').toUpperCase()+" ";}ctx.fillStyle=y%2===0?"#888":"#00ffcc";ctx.fillText(l,20,y*16);idx+=16;}}
    let parts=[];function drawGravity(ctx,w,h,bass){if(parts.length<50)parts.push({x:Math.random()*w,y:0,v:0,c:'*'});parts.forEach(p=>{p.v+=0.5;p.y+=p.v;const aidx=Math.floor(map(p.x,0,w,0,bufferLength)),val=dataArray?dataArray[aidx]:0,flr=h-(val*1.5);if(p.y>=flr){p.y=flr;p.v*=-0.8;}if(p.y>h)p.y=0;ctx.fillStyle="#fff";ctx.fillText(p.c,p.x,p.y);});}
    let rings=[];function drawSonar(ctx,w,h,bass){const cx=w/2,cy=h/2;if(bass>0.5&&Math.random()>0.8)rings.push({r:0,l:1});rings.forEach((r,i)=>{r.r+=5;r.l-=0.01;if(r.l<=0){rings.splice(i,1);return;}for(let j=0;j<36;j++){const a=(j/36)*Math.PI*2,x=cx+Math.cos(a)*r.r,y=cy+Math.sin(a)*r.r;ctx.fillStyle=`rgba(0,255,204,${r.l})`;ctx.fillText(".",x,y);}});}
    function drawGlitch(ctx,w,h,bass){const cnt=bass*200;for(let i=0;i<cnt;i++){const x=Math.random()*w,y=Math.random()*h,c=String.fromCharCode(33+Math.floor(Math.random()*90));ctx.fillStyle=Math.random()>0.5?"#fff":"#ff3333";ctx.fillText(c,x,y);}ctx.fillStyle="#00ffcc";ctx.fillText("SYSTEM CORRUPTION...",w/2-50,h/2);}
    let sHist=[];function drawSeismograph(ctx,w,h){let avg=0;if(dataArray){for(let i=0;i<bufferLength;i++)avg+=dataArray[i];avg/=bufferLength;}sHist.push(avg);if(sHist.length>w/5)sHist.shift();ctx.fillStyle="#ff3333";for(let i=0;i<sHist.length;i++){const v=sHist[i],y=h/2+(Math.random()-0.5)*v;ctx.fillText(".",i*5,y);if(v>100)ctx.fillText("|",i*5,y);}}
    let stars=[];function drawStarfield(ctx,w,h,bass){if(stars.length<100)stars.push({x:Math.random()*w,y:Math.random()*h,z:Math.random()*2});const cx=w/2,cy=h/2,spd=1+bass*10;stars.forEach(s=>{const dx=s.x-cx,dy=s.y-cy,d=Math.sqrt(dx*dx+dy*dy);s.x+=(dx/d)*spd*s.z;s.y+=(dy/d)*spd*s.z;if(s.x<0||s.x>w||s.y<0||s.y>h){s.x=Math.random()*w;s.y=Math.random()*h;}ctx.fillStyle="#fff";ctx.fillText(spd>5?"|":".",s.x,s.y);});}
    function drawNetwork(ctx,w,h,bass){const nodes=20,r=Math.min(w,h)/3,cx=w/2,cy=h/2,np=[];for(let i=0;i<nodes;i++){const v=dataArray?dataArray[i*5]:0,a=(i/nodes)*Math.PI*2,d=r+(v/255)*100,nx=cx+Math.cos(a)*d,ny=cy+Math.sin(a)*d;np.push({x:nx,y:ny,v:v});ctx.fillStyle="#00ffcc";ctx.fillText("O",nx,ny);}ctx.strokeStyle="rgba(0,255,204,0.3)";ctx.beginPath();for(let i=0;i<nodes;i++)for(let j=i+1;j<nodes;j++)if(Math.abs(np[i].v-np[j].v)<20+bass*50){ctx.moveTo(np[i].x,np[i].y);ctx.lineTo(np[j].x,np[j].y);}ctx.stroke();}
    function drawCompass(ctx,w,h,bass){const cx=w/2,cy=h/2,a=Date.now()*0.001+(bass*Math.PI),len=150,ex=cx+Math.cos(a)*len,ey=cy+Math.sin(a)*len;ctx.fillStyle="#fff";ctx.fillText("N",cx,cy-170);ctx.fillText("S",cx,cy+170);ctx.fillText("E",cx+170,cy);ctx.fillText("W",cx-170,cy);for(let i=0;i<20;i++){const lx=cx+(ex-cx)*(i/20),ly=cy+(ey-cy)*(i/20);ctx.fillStyle=i>10?"#ff3333":"#fff";ctx.fillText("+",lx,ly);}}
    function drawBarcode(ctx,w,h){const bars=40,bw=w/bars;for(let i=0;i<bars;i++){const v=dataArray?dataArray[i*2]:0,th=Math.floor(v/20);ctx.fillStyle="#000";ctx.fillRect(i*bw,0,bw,h);ctx.fillStyle="#fff";for(let t=0;t<th;t++)ctx.fillText("|",i*bw+t*2,h/2);ctx.fillText(v,i*bw,h/2+20);}}
    function drawTerminal(ctx,w,h){const lines=Math.floor(h/16);for(let i=0;i<lines;i++){const v=dataArray?dataArray[i]:0,cmd=`PROC_${i*392}: [${"#".repeat(Math.floor(v/10))}] ${v}%`;ctx.fillStyle=i===10?"#fff":"#00ffcc";ctx.fillText(cmd,20,i*16);}}
    function drawHeatmap(ctx,w,h){const cols=Math.floor(w/20),rows=Math.floor(h/20);for(let y=0;y<rows;y++)for(let x=0;x<cols;x++){const idx=(x+y*cols)%bufferLength,v=dataArray?dataArray[idx]:0,c=v>200?"@":v>150?"#":v>100?"x":v>50?":":".",hue=240-(v/255*240);ctx.fillStyle=`hsl(${hue},100%,50%)`;ctx.fillText(c,x*20,y*20);}}
    let vpHist=[];function drawVoiceprint(ctx,w,h){let l=[];for(let i=0;i<64;i++)l.push(dataArray?dataArray[i*4]:0);vpHist.unshift(l);if(vpHist.length>h/10)vpHist.pop();vpHist.forEach((r,y)=>{r.forEach((v,x)=>{ctx.fillStyle=`rgba(0,255,204,${v/255})`;ctx.fillText(v>128?"█":"░",x*12+w/2-384,y*10);});});}
    function drawGlobe(ctx,w,h,bass){const cx=w/2,cy=h/2,r=150+bass*50,lat=12,lon=24,t=Date.now()*0.001;for(let i=0;i<=lat;i++){const phi=Math.PI*i/lat;for(let j=0;j<=lon;j++){const theta=Math.PI*2*j/lon+t,x3=r*Math.sin(phi)*Math.cos(theta),y3=r*Math.cos(phi),z3=r*Math.sin(phi)*Math.sin(theta)+r*2,scale=300/(300+z3),x2d=cx+x3*scale,y2d=cy+y3*scale;if(z3>0){ctx.fillStyle=j%2===0?"#00ffcc":"#fff";ctx.fillText("+",x2d,y2d);}}}}
    function drawNoise(ctx,w,h){for(let i=0;i<1000;i++){const x=Math.random()*w,y=Math.random()*h,v=dataArray?dataArray[Math.floor(Math.random()*bufferLength)]:0;if(v>128){ctx.fillStyle="#fff";ctx.fillText(Math.random()>0.5?"0":"1",x,y);}}}
    let btX=0;function drawHeartbeat(ctx,w,h,bass){const cy=h/2;btX+=5;if(btX>w)btX=0;let y=cy;if(bass>0.4&&btX%100<20)y=cy-(bass*200*Math.sin((btX%20)/20*Math.PI));else y=cy+(Math.random()-0.5)*10;ctx.fillStyle="#00ffcc";ctx.font="20px monospace";ctx.fillText("♥",btX,y);ctx.fillStyle="#ff3333";ctx.fillText("BPM: "+(60+Math.floor(bass*60)),20,50);}
    function drawKaleidoscope(ctx,w,h,bass){const cx=w/2,cy=h/2,t=Date.now()*0.0005,segs=8;for(let s=0;s<segs;s++){ctx.save();ctx.translate(cx,cy);ctx.rotate(t+(s*(Math.PI*2/segs)));for(let i=0;i<20;i++){const val=dataArray?dataArray[i*5]:0,r=i*10+val/2;ctx.fillStyle=`hsl(${val+s*30},100%,50%)`;ctx.fillText(val>150?"#":"*",r,r*Math.sin(t));ctx.scale(1,-1);ctx.fillText(val>150?"#":"*",r,r*Math.sin(t));}ctx.restore();}}
    function drawCircuitBoard(ctx,w,h,bass){const gs=40;ctx.strokeStyle="#00ffcc";ctx.lineWidth=2;ctx.beginPath();for(let i=0;i<bufferLength;i+=10){const val=dataArray?dataArray[i]:0;if(val<50)continue;const x=(i%(w/gs))*gs,y=(Math.floor(i/(w/gs)))*gs;ctx.moveTo(x,y);if(val>150)ctx.lineTo(x+gs,y);else if(val>100)ctx.lineTo(x,y+gs);ctx.fillStyle=val>200?"#fff":"#00ffcc";ctx.fillText("o",x-3,y-3);}ctx.stroke();if(bass>0.5){ctx.fillStyle="rgba(0,255,204,0.1)";ctx.fillRect(0,0,w,h);}}
    function drawCitySkyline(ctx,w,h,bass){const bld=64,bw=w/bld;for(let i=0;i<bld;i++){const val=dataArray?dataArray[i*2]:0,bh=(val/255)*h*0.8;ctx.fillStyle="#222";ctx.fillRect(i*bw,h-bh,bw-2,bh);ctx.fillStyle=val>180?"#ffff00":"#555";for(let wy=h-bh+10;wy<h;wy+=20)ctx.fillText("[ ]",i*bw+5,wy);}ctx.fillStyle=bass>0.6?"#fff":"#ff3333";ctx.beginPath();ctx.arc(w-100,100,50+bass*20,0,Math.PI*2);ctx.fill();}
    function drawBlackHole(ctx,w,h,bass){const cx=w/2,cy=h/2,r=100+bass*50;ctx.fillStyle="#000";ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#ff3333";ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,r+5,0,Math.PI*2);ctx.stroke();const parts=200,t=Date.now()*0.002;for(let i=0;i<parts;i++){const val=dataArray?dataArray[i%bufferLength]:0,a=t+i+(bass*i*0.01),d=r+20+(val/255)*200,x=cx+Math.cos(a)*d,y=cy+Math.sin(a)*d*0.4;ctx.fillStyle=`hsl(${val/2},100%,50%)`;ctx.fillText(".",x,y);}}
    let fluid=[];function drawFluid(ctx,w,h,bass){ctx.fillStyle="rgba(0,0,0,0.1)";ctx.fillRect(0,0,w,h);if(bass>0.3){for(let i=0;i<5;i++)fluid.push({x:w/2+(Math.random()-0.5)*100,y:h,vx:(Math.random()-0.5)*2,vy:-2-Math.random()*5,l:1,h:bass*360});}fluid.forEach((p,i)=>{p.x+=p.vx+Math.sin(p.y*0.05)*2;p.y+=p.vy;p.l-=0.005;ctx.fillStyle=`hsla(${p.h},100%,50%,${p.l})`;ctx.beginPath();ctx.arc(p.x,p.y,10*p.l,0,Math.PI*2);ctx.fill();if(p.l<=0)fluid.splice(i,1);});}
    function drawRetroCRT(ctx,w,h,bass){const t=Date.now()*0.005,jx=bass>0.7?(Math.random()-0.5)*20:0;ctx.save();ctx.translate(w/2,h/2);const s=1+bass*0.05;ctx.scale(s,s);ctx.translate(-w/2+jx,-h/2);drawSpectrum(ctx,w,h);drawTerminal(ctx,w,h);if(bass>0.8){ctx.globalCompositeOperation="screen";ctx.fillStyle="rgba(255,0,0,0.5)";ctx.fillText("RGB SEPARATION FAULT",50+jx,50);ctx.fillStyle="rgba(0,255,255,0.5)";ctx.fillText("RGB SEPARATION FAULT",45+jx,50);}ctx.restore();}
    let neur=[];function drawNeuralNet(ctx,w,h,bass){if(neur.length<30)neur.push({x:Math.random()*w,y:Math.random()*h,v:0});neur.forEach((n,i)=>{n.v=dataArray?dataArray[i*5]:0;ctx.fillStyle=`rgba(0,255,204,${n.v/255})`;ctx.beginPath();ctx.arc(n.x,n.y,5+n.v/20,0,Math.PI*2);ctx.fill();});ctx.strokeStyle="rgba(0,255,204,0.2)";ctx.beginPath();for(let i=0;i<neur.length;i++)for(let j=i+1;j<neur.length;j++){if(Math.hypot(neur[i].x-neur[j].x,neur[i].y-neur[j].y)<150&&(neur[i].v+neur[j].v)/2>100){ctx.moveTo(neur[i].x,neur[i].y);ctx.lineTo(neur[j].x,neur[j].y);}}ctx.stroke();}
    function drawLightning(ctx,w,h,bass){ctx.fillStyle="rgba(0,0,0,0.3)";ctx.fillRect(0,0,w,h);if(bass<0.5&&Math.random()>0.1)return;let cx=Math.random()*w,cy=0;ctx.strokeStyle="#fff";ctx.lineWidth=3+bass*5;ctx.beginPath();ctx.moveTo(cx,0);while(cy<h){cx+=(Math.random()-0.5)*50;cy+=Math.random()*20+5;ctx.lineTo(cx,cy);}ctx.stroke();ctx.fillStyle="rgba(255,255,255,0.8)";ctx.fillRect(0,0,w,h);}
    function drawPlanets(ctx,w,h,bass){const cx=w/2,cy=h/2;ctx.fillStyle="#ffaa00";ctx.beginPath();ctx.arc(cx,cy,30+bass*20,0,Math.PI*2);ctx.fill();const cnt=8,t=Date.now()*0.0005;for(let i=1;i<=cnt;i++){const v=dataArray?dataArray[i*20]:0,r=i*40,s=t*(cnt-i+1)*0.2+bass,px=cx+Math.cos(s)*r,py=cy+Math.sin(s)*r*0.6;ctx.fillStyle=`hsl(${i*40},100%,50%)`;ctx.beginPath();ctx.arc(px,py,5+v/30,0,Math.PI*2);ctx.fill();ctx.strokeStyle="rgba(255,255,255,0.1)";ctx.beginPath();ctx.ellipse(cx,cy,r,r*0.6,0,0,Math.PI*2);ctx.stroke();}}
    let inkOff=0;function drawRorschach(ctx,w,h,bass){const cx=w/2,cy=h/2;inkOff+=bass;for(let i=0;i<200;i++){const v=dataArray?dataArray[i]:0,a=i*0.1+inkOff*0.01,d=v*(0.5+bass),x=Math.cos(a)*d,y=Math.sin(a*1.5)*d;ctx.fillStyle="#000";ctx.beginPath();ctx.arc(cx+x,cy+y,5+bass*5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx-x,cy+y,5+bass*5,0,Math.PI*2);ctx.fill();}}
    const skull=[" .d88888b. ","d88P\" \"Y88b","888     888","888     888","888     888","888     888","Y88b. .d88P"," \"Y88888P\" "];function drawAsciiPortrait(ctx,w,h,bass){const cx=w/2-50,cy=h/2-50;ctx.font="20px monospace";skull.forEach((l,i)=>{let j=bass>0.6?(Math.random()-0.5)*10:0;ctx.fillStyle=bass>0.8?"#ff3333":"#e0e0e0";ctx.fillText(l,cx+j,cy+i*20);});if(bass>0.4){ctx.fillStyle="#ff0000";ctx.fillText("O",cx+30,cy+60);ctx.fillText("O",cx+70,cy+60);}}
    function drawSpirograph(ctx,w,h,bass){const cx=w/2,cy=h/2,R=100,r=60+bass*40,O=50,t=Date.now()*0.002;ctx.strokeStyle=`hsl(${t*10},100%,50%)`;ctx.lineWidth=2;ctx.beginPath();for(let i=0;i<360;i++){const rad=toRad(i)+t,x=(R-r)*Math.cos(rad)+O*Math.cos(((R-r)/r)*rad),y=(R-r)*Math.sin(rad)-O*Math.sin(((R-r)/r)*rad);if(i===0)ctx.moveTo(cx+x,cy+y);else ctx.lineTo(cx+x,cy+y);}ctx.stroke();}
    let trkP=0;function drawTankTracks(ctx,w,h,bass){trkP-=2+bass*5;const tW=100;for(let x=w/2-tW;x<=w/2+tW;x+=tW*2)for(let y=-50;y<h+50;y+=30){const py=(y+trkP)%(h+50);ctx.fillStyle="#555";ctx.fillRect(x,py,30,10);ctx.fillStyle="#888";ctx.fillText("[==]",x+2,py-2);}}
    function drawDigitalRainbow(ctx,w,h){const bars=128,bw=w/bars;for(let i=0;i<bars;i++){const v=dataArray?dataArray[i*2]:0,bh=(v/255)*h;ctx.fillStyle=`hsl(${i/bars*360}, 100%, 50%)`;ctx.fillRect(i*bw,h-bh,bw,bh);}}
    let fws=[];function drawFireworks(ctx,w,h,bass){ctx.fillStyle="rgba(0,0,0,0.2)";ctx.fillRect(0,0,w,h);if(bass>0.7&&Math.random()>0.7){const fx=Math.random()*w,fy=Math.random()*h/2,c=`hsl(${Math.random()*360},100%,50%)`;for(let i=0;i<30;i++)fws.push({x:fx,y:fy,vx:Math.cos(i/30*Math.PI*2)*5,vy:Math.sin(i/30*Math.PI*2)*5,l:1,c:c});}fws.forEach((f,i)=>{f.x+=f.vx;f.y+=f.vy;f.vy+=0.1;f.l-=0.02;ctx.fillStyle=f.c.replace(")",`,${f.l})`);ctx.beginPath();ctx.arc(f.x,f.y,3,0,Math.PI*2);ctx.fill();if(f.l<=0)fws.splice(i,1);});}
    let tunZ=0;function drawTunnelDive(ctx,w,h,bass){ctx.fillStyle="rgba(0,0,0,0.3)";ctx.fillRect(0,0,w,h);const cx=w/2,cy=h/2;tunZ+=5+bass*10;for(let i=0;i<20;i++){const z=(tunZ+i*100)%2000,s=200/(z||1),r=500*s,v=dataArray?dataArray[i*10]:0;ctx.strokeStyle=`hsl(${v},100%,${50*s}%)`;ctx.lineWidth=2*s;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.stroke();}}
    function drawLiquidMetal(ctx,w,h,bass){ctx.fillStyle="rgba(0,0,0,0.1)";ctx.fillRect(0,0,w,h);const cx=w/2,cy=h/2,r=100;ctx.fillStyle="#ccc";ctx.beginPath();for(let i=0;i<360;i+=5){const v=dataArray?dataArray[Math.floor(i/360*bufferLength)]:0,nr=r+(v/255)*100*(1+bass),rad=toRad(i+Date.now()*0.1),x=cx+Math.cos(rad)*nr,y=cy+Math.sin(rad)*nr;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.closePath();ctx.fill();const g=ctx.createRadialGradient(cx-r/2,cy-r/2,10,cx,cy,r*1.5);g.addColorStop(0,"rgba(255,255,255,0.8)");g.addColorStop(1,"rgba(100,100,100,0)");ctx.fillStyle=g;ctx.fill();}
    function drawNixieTubes(ctx,w,h,bass){const n=6,tw=w/n;for(let i=0;i<n;i++){const v=dataArray?dataArray[i*30]:0,d=Math.floor(v/25.6),x=i*tw+tw/2-20,y=h/2;ctx.fillStyle="rgba(255,100,50,0.2)";ctx.fillRect(x-10,y-40,60,80);ctx.fillStyle="rgba(50,50,50,0.5)";for(let gy=y-40;gy<y+40;gy+=5)ctx.fillText(":::::",x,gy);ctx.font="40px monospace";ctx.fillStyle="#ff6600";ctx.shadowColor="#ff6600";ctx.shadowBlur=20+bass*20;ctx.fillText(d,x+10,y+10);ctx.shadowBlur=0;}}
    let vPts=[];function drawVoronoi(ctx,w,h,bass){if(vPts.length<20)vPts.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*2,vy:(Math.random()-0.5)*2});vPts.forEach((p,i)=>{p.x+=p.vx*(1+bass);p.y+=p.vy*(1+bass);if(p.x<0||p.x>w)p.vx*=-1;if(p.y<0||p.y>h)p.vy*=-1;const v=dataArray?dataArray[i*10]:0;ctx.fillStyle=`hsl(${v},100%,50%)`;ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();});ctx.strokeStyle="#333";for(let i=0;i<vPts.length;i++)for(let j=i+1;j<vPts.length;j++){if(Math.hypot(vPts[i].x-vPts[j].x,vPts[i].y-vPts[j].y)<200){ctx.beginPath();ctx.moveTo(vPts[i].x,vPts[i].y);ctx.lineTo(vPts[j].x,vPts[j].y);ctx.stroke();}}}
    const wds=["BASS","FREQ","BEAT","WAVE","DATA","CORE","SYNC","FLOW","PULSE","NODE"];function drawTextCloud(ctx,w,h,bass){for(let i=0;i<wds.length;i++){const v=dataArray?dataArray[i*20]:0,sz=10+(v/255)*50*(1+bass),x=(w/wds.length)*i+50,y=h/2+Math.sin(Date.now()*0.001+i)*100;ctx.font=`${sz}px monospace`;ctx.fillStyle=v>180?"#fff":"#00ffcc";ctx.fillText(wds[i],x,y);}}
    let rips=[];function drawRippleTank(ctx,w,h,bass){if(bass>0.5&&Math.random()>0.8)rips.push({x:Math.random()*w,y:Math.random()*h,r:0,a:1});rips.forEach((r,i)=>{r.r+=5;r.a-=0.02;ctx.strokeStyle=`rgba(0,255,255,${r.a})`;ctx.beginPath();ctx.arc(r.x,r.y,r.r,0,Math.PI*2);ctx.stroke();if(r.a<=0)rips.splice(i,1);});}
    function drawTeslaCoil(ctx,w,h,bass){const cx=w/2,cy=h-50;ctx.fillStyle="#555";ctx.fillRect(cx-20,cy,40,50);ctx.fillStyle="#888";ctx.beginPath();ctx.arc(cx,cy,30,0,Math.PI*2);ctx.fill();if(bass>0.3){const arcs=Math.floor(bass*10);for(let i=0;i<arcs;i++){ctx.strokeStyle="#00ffff";ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(cx,cy);let x=cx,y=cy,tx=Math.random()*w,ty=Math.random()*h/2;for(let j=0;j<10;j++){x+=(tx-cx)/10+(Math.random()-0.5)*50;y+=(ty-cy)/10+(Math.random()-0.5)*50;ctx.lineTo(x,y);}ctx.stroke();}}}
    function drawPixelSort(ctx,w,h,bass){drawSpectrum(ctx,w,h);if(bass>0.4){const sh=Math.floor(bass*50),sy=Math.random()*(h-sh);for(let i=0;i<sh;i++){const v=dataArray?dataArray[i*2]:0;ctx.fillStyle=v>150?"#fff":"#00ffcc";ctx.fillRect(0,sy+i,w,1);}}}
    function drawHUD(ctx,w,h,bass){const cx=w/2,cy=h/2;ctx.strokeStyle="#00ffcc";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(cx-50,cy);ctx.lineTo(cx+50,cy);ctx.moveTo(cx,cy-50);ctx.lineTo(cx,cy+50);ctx.stroke();ctx.beginPath();ctx.arc(cx,cy,100+bass*20,0,Math.PI*2);ctx.stroke();ctx.setLineDash([5,5]);ctx.beginPath();ctx.arc(cx,cy,200,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.fillStyle=bass>0.8?"#ff3333":"#00ffcc";ctx.fillText(bass>0.8?"LOCK":"SCAN",cx+120,cy);for(let i=-5;i<=5;i++){const y=cy+i*30;ctx.moveTo(cx-20,y);ctx.lineTo(cx+20,y);ctx.stroke();if(i!==0)ctx.fillText(Math.abs(i)*10,cx+25,y+5);}}
    let wrm=[];function drawSoundWorm(ctx,w,h,bass){const t=Date.now()*0.005,hx=w/2+Math.cos(t)*w/3,hy=h/2+Math.sin(t*1.5)*h/4;wrm.unshift({x:hx,y:hy});if(wrm.length>100)wrm.pop();wrm.forEach((s,i)=>{const v=dataArray?dataArray[i%bufferLength]:0,r=10+(v/255)*20;ctx.fillStyle=`hsl(${i*5},100%,50%)`;ctx.beginPath();ctx.arc(s.x,s.y,r,0,Math.PI*2);ctx.fill();});}
    function drawCropCircles(ctx,w,h,bass){const cx=w/2,cy=h/2;ctx.strokeStyle="#aaa";ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,100,0,Math.PI*2);ctx.stroke();for(let i=0;i<6;i++){const a=toRad(i*60+Date.now()*0.1),v=dataArray?dataArray[i*20]:0,d=150+v/2,r=20+bass*20;ctx.beginPath();ctx.arc(cx+Math.cos(a)*d,cy+Math.sin(a)*d,r,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(a)*d,cy+Math.sin(a)*d);ctx.stroke();}}
    function drawFractalTree(ctx,w,h,bass){ctx.strokeStyle="#00ffcc";ctx.lineWidth=2;drawBranch(ctx,w/2,h,100+bass*50,-Math.PI/2,10);}
    function drawBranch(ctx,x,y,l,a,d){if(d===0)return;const ex=x+l*Math.cos(a),ey=y+l*Math.sin(a);ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(ex,ey);ctx.stroke();const s=Math.PI/4+(dataArray?dataArray[d*5]/255:0);drawBranch(ctx,ex,ey,l*0.7,a-s,d-1);drawBranch(ctx,ex,ey,l*0.7,a+s,d-1);}
    function drawMagneticField(ctx,w,h,bass){const cx=w/2,cy=h/2;ctx.fillStyle="#f33";ctx.fillRect(cx-50,cy-20,40,40);ctx.fillText("N",cx-45,cy+5);ctx.fillStyle="#33f";ctx.fillRect(cx+10,cy-20,40,40);ctx.fillText("S",cx+15,cy+5);ctx.fillStyle="#888";for(let x=0;x<w;x+=20)for(let y=0;y<h;y+=20){const a=(Math.atan2(y-cy,x-(cx-30))-Math.atan2(y-cy,x-(cx+30)))*(1+bass*2);ctx.save();ctx.translate(x,y);ctx.rotate(a);ctx.fillText("-",0,0);ctx.restore();}}
    function drawEQRings(ctx,w,h,bass){const cx=w/2,cy=h/2;ctx.lineWidth=5;for(let i=0;i<32;i++){const v=dataArray?dataArray[i*4]:0,r=i*10+20,e=-Math.PI/2+(v/255)*Math.PI*2;ctx.strokeStyle=`hsl(${i*10},100%,50%)`;ctx.beginPath();ctx.arc(cx,cy,r,-Math.PI/2,e);ctx.stroke();}}
    function drawTheAbyss(ctx,w,h,bass){const cx=w/2,cy=h/2,g=ctx.createRadialGradient(cx,cy,50*bass,cx,cy,w/2);g.addColorStop(0,"#000");g.addColorStop(1,"#203");ctx.fillStyle=g;ctx.fillRect(0,0,w,h);const eo=10+bass*50;ctx.fillStyle="#fff";ctx.beginPath();ctx.ellipse(cx,cy,100,eo,0,0,Math.PI*2);ctx.fill();ctx.fillStyle="#000";ctx.beginPath();ctx.arc(cx,cy,20+bass*10,0,Math.PI*2);ctx.fill();ctx.fillStyle="#f00";ctx.beginPath();ctx.arc(cx,cy,5+bass*5,0,Math.PI*2);ctx.fill();ctx.fillStyle="#fff";ctx.fillText("IT SEES.",cx-30,cy+100);}


    // --- UI LOGIC ---
    function log(msg, type="sys") { const d=document.createElement('div'); d.className=`log-entry ${type}`; d.textContent=msg; DOM.history.appendChild(d); DOM.history.scrollTop=DOM.history.scrollHeight; }
    
    function togglePanel() { 
        const isClosed = DOM.panel.style.display === "none" || DOM.panel.style.display === "";
        DOM.panel.style.display = isClosed ? "block" : "none";
        if (isClosed) DOM.history.classList.add('dimmed');
        else DOM.history.classList.remove('dimmed');
        DOM.input.focus();
    }
    
    function initPanel() {
        DOM.grid.innerHTML = "";
        MODES.forEach(m => {
            const btn = document.createElement('div'); btn.className = "module-btn";
            btn.textContent = `[${m.id.toString().padStart(2, '0')}] ${m.name}`;
            btn.title = m.desc;
            btn.onclick = () => { 
                STATE.mode = m.id; 
                log(`Visual: ${m.name}`, "success"); 
                initPanel();
                DOM.input.focus();
            };
            if (m.id === STATE.mode) btn.classList.add('active');
            DOM.grid.appendChild(btn);
        });
    }

    DOM.trigger.onclick = togglePanel;
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Tab') { e.preventDefault(); DOM.ui.classList.toggle('hidden'); }
    });

    function playTrack(idx) {
        if (!STATE.playlist.length) return log("Error: Mount media first.", "warn");
        if (idx >= STATE.playlist.length) idx = 0; STATE.trackIndex = idx;
        const file = STATE.playlist[idx]; initAudio();
        audioEl.src = URL.createObjectURL(file);
        audioEl.play().then(() => {
            STATE.isPlaying = true; log(`Playing: ${file.name}`, "success");
            DOM.trigger.style.display = "block";
        });
    }
    function playNext() { playTrack(STATE.trackIndex + 1); }

    const COMMANDS = {
        'load': () => { document.getElementById('file-input').click(); return "Mounting..."; },
        'play': () => { if(audioEl.src) audioEl.play(); STATE.isPlaying=true; return "Resuming..."; },
        'pause': () => { audioEl.pause(); STATE.isPlaying=false; return "Holding..."; },
        'help': () => "CMDS: load, play, pause, [Tab] to hide UI"
    };

    DOM.input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const val = DOM.input.value.trim(); DOM.input.value = ""; if (!val) return;
            log(`USER@TYPER:~$ ${val}`);
            const args = val.split(" "); const cmd = args[0].toLowerCase();
            if (COMMANDS[cmd]) { const res = COMMANDS[cmd](args); if (res) log(res, "sys"); }
            else { log("Unknown Protocol.", "warn"); }
        }
    });
    document.getElementById('file-input').addEventListener('change', (e) => {
        STATE.playlist = Array.from(e.target.files);
        log(`Buffer: ${STATE.playlist.length} files mounted.`, "success"); playTrack(0);
    });

    initPanel(); log("TYPER OMNI CORE TUBE [ONLINE]", "sys"); render();
</script>
</body>
</html>